<template>
  <div class="pt-5 m-6 main-container">
    <div class="p-5" style="display: flex; justify-content: center">
      <v-text-field
        label="Search"
        hide-details
        prepend-icon="mdi-magnify"
        single-line
        style="max-width: 600px"
        v-model="name"
        @keyup.enter="search"
      ></v-text-field>
    </div>
    <v-row class="dashboard-container">
      <v-col
        cols="12"
        sm="12"
        md="6"
        lg="3"
        class="right-contents"
        order-md="1"
        order-sm="1"
        order-lg="3"
        order-xs="1"
      >
        <v-sheet rounded="lg" min-height="268">
          <v-card elevation="6" class="p-3">
            <div class="proposal-title">
              <h3 class="text-center">Job Requests</h3>
            </div>
            <v-divider></v-divider>
            <div v-if="allRequests">
              <div v-for="index in 3" :key="index">
                <div>
                  <Requests
                    v-if="allRequests[index - 1]"
                    :request="allRequests[index - 1]"
                  />
                </div>
              </div>
              <v-btn width="100%" @click="seeAll">See All</v-btn>
            </div>
            <div v-else>
              <v-alert
                border="left"
                colored-border
                color="red accent-4"
                elevation="2"
                style="width: 100%"
              >
                <div class="d-flex ml-5">
                  <p>No requests yet!</p>
                </div>
              </v-alert>
            </div>
          </v-card>
        </v-sheet>
      </v-col>
      <v-col
        cols="12"
        sm="12"
        md="6"
        lg="3"
        order-md="2"
        order-sm="2"
        order-lg="1"
        order-xs="2"
      >
        <v-sheet rounded="lg" min-height="268">
          <v-card elevation="6" class="p-3">
            <h3>Filter</h3>
            <v-divider></v-divider>
            <FilterBy
              class="filter"
              @categoryChange="getCategory"
              @rangeChange="getRange"
            />
          </v-card>
        </v-sheet>
      </v-col>

      <v-col
        cols="12"
        sm="12"
        md="12"
        lg="6"
        class="right-contents"
        order-md="3"
        order-sm="3"
        order-lg="2"
        order-xs="3"
      >
        <v-main>
          <v-container>
            <v-row>
              <h2 style="text-align: center">Find Employees!</h2>
              <div v-if="filterUsers.length > 0">
                <v-col
                  v-for="a_user in filterUsers"
                  :key="a_user.employee_id"
                  cols="12"
                  md="12"
                >
                  <Users :a_user="a_user" />
                </v-col>
              </div>
              <div v-else>
                <v-col cols="12" md="12">
                  <v-skeleton-loader
                    v-bind="attrs"
                    type="card-avatar, article, actions"
                  ></v-skeleton-loader>
                  <div class="mt-2">
                    <v-alert dense type="info">
                      No users
                    </v-alert>
                  </div>
                </v-col>
              </div>
            </v-row>
          </v-container>
        </v-main>
      </v-col>
    </v-row>
  </div>
</template>

<script>
import FilterBy from "../app_component/filter.vue";
import Jobs from "../app_component/dashboardJob.vue";
import User from "../app_component/user.vue";
import Requests from "../app_component/requests.vue";
import Users from "../app_component/userCard.vue";
import { mapActions } from "vuex";
import { mapGetters } from "vuex";

export default {
  components: {
    FilterBy,
    Jobs,
    User,
    Requests,
    Users,
  },
  name: "dashboard",
  data() {
    return {
      category: "",
      name: "",
      min: "0",
      max: "70000",
      allUsers: [],
      filterU: [],
    };
  },
  computed: {
    ...mapGetters({
      allRequests: "requests/job_Request",
    }),
    filterUsers: function () {
      return this.filterByRange(
        this.filterByCategory(this.filterByName(this.allUsers))
      );
    },
  },
  methods: {
    search() {
      console.log(this.name);
    },
    getCategory(value) {
      if (value) {
        console.log(value);
        this.category = value;
      } else {
        this.category = [];
      }
    },
    getRange(value) {
      if (value) {
        console.log(value[0], value[1]);

        this.min = value[0];
        this.max = value[1];
      } else {
        this.min = "0";
        this.max = "70000";
      }
    },
    async fetchUsers() {
      const res = await axios.get("employee/all");

      const data = await res.data;

      return data;
    },
    ...mapActions({
      fetchRequests: "requests/fetchRequest",
    }),
    seeAll() {
      this.$router
        .push({
          name: "jobRequest",
          params: {
            job: this.allRequests,
          },
        })
        .catch(() => {});
    },
    filterByCategory: function (allUsers) {
      return allUsers.filter(
        (allUsers) =>
          !allUsers.job_categories.category_name.indexOf(this.category)
      );
    },

    filterByName: function (allUsers) {
      return allUsers.filter(
        (allUsers) =>
          !allUsers.user.first_name
            .toLowerCase()
            .indexOf(this.name.toLowerCase()) ||
          !allUsers.user.last_name
            .toLowerCase()
            .indexOf(this.name.toLowerCase())
      );
    },

    filterByRange: function (allUsers) {
      return allUsers.filter((allUsers) =>
        allUsers.project_rate > this.min && allUsers.project_rate < this.max
          ? allUsers
          : ""
      );
    },
  },
  async created() {
    this.allUsers = await this.fetchUsers();
    console.log(this.allUsers);
    await this.fetchRequests();
  },
};
</script>

<style scoped>
</style>
